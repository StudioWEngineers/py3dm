name: Tests

on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: test-${{ github.ref }}
  cancel-in-progress: false

jobs:
  check_relevant_changes:
    name: check for relevant changes
    runs-on: ubuntu-latest
    outputs:
      any_changed: ${{ steps.changed-files.outputs.any_changed }}
    steps:
      - name: checkout
        uses: actions/checkout@v4.1.1
        with:
          fetch-depth: 2
      - name: check changed files
        uses: tj-actions/changed-files@v45.0.4
        id: changed-files
        with:
          files: |
            .github/workflows/workflow_ci.yml
            py3dm/__init__.py
            src/**/*.h
            src/**/*.cpp
            tests/**
            CMakeLists.txt
            pyproject.toml
      - name: List all changed files
        env:
          ALL_CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          for file in ${ALL_CHANGED_FILES}; do
            echo "$file was changed"
          done

  cpython_build_and_test_clang_on_windows:
    needs: [check_relevant_changes]
    if: needs.check_relevant_changes.outputs.any_changed == 'true'

    strategy:
      fail-fast: false
      matrix:
        os: ['windows-latest']
        python: ['3.12']

    name: "Python ${{ matrix.python }} / ${{ matrix.os }} / CLANG"
    runs-on: ${{ matrix.os }}

    steps:
      - name: set up python ${{ matrix.python }}
        uses: actions/setup-python@v5.4.0
        with:
          python-version: ${{ matrix.python }}

      - name: install the latest CMake
        uses: lukka/get-cmake@latest

      - name: install Ninja
        run: choco install ninja

      - name: install LLVM/Clang
        uses: egor-tensin/setup-clang@v1

      - name: install dependencies
        run: python -m pip install --upgrade pip setuptools wheel build scikit-build-core nanobind

      - name: checkout
        uses: actions/checkout@v4.1.1

      - name: update submodules
        run: git submodule update --init --recursive

      - name: build ${{ matrix.python }} ${{ matrix.os }}
        run: |
          $env:SKBUILD_CMAKE_ARGS = "-G", "Ninja", "-DCMAKE_CXX_FLAGS=-Wno-c++11-narrowing"
          $env:SKBUILD_CMAKE_DEFINE = "CMAKE_C_COMPILER=clang;CMAKE_CXX_COMPILER=clang++"
          $env:CC = "clang"
          $env:CXX = "clang++"
          python -m build --no-isolation
        shell: pwsh

      - name: install package
        run: |
          cd dist
          python -m pip install *.whl
        shell: bash

      - name: test ${{ matrix.python }} ${{ matrix.os }}
        run: |
          cd tests
          python -m unittest discover --verbose
        shell: bash
